<html>
    <head>
        <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
        <script>
            grist.ready({
                requiredAccess: "full",
                columns: [{ name: "Attachment" }, { name: "Url" }],
            });
            grist.onRecords(async (records, mappings) => {
                const tokenInfo = await grist.docApi.getAccessToken({
                    readOnly: true,
                });
                var actions = [];
                const table = await grist.getTable();
                const tableId = await table.getTableId();
                for (const record of records) {
                    const att_id = record[mappings.Attachment][0];
                    const id = record.id;

                    const src = `${tokenInfo.baseUrl}/attachments/${att_id}/download?auth=${tokenInfo.token}`;
                    const fields = { [mappings.Url]: src };
                    actions.push(["UpdateRecord", tableId, id, fields]);
                }
                grist.docApi.applyUserActions(actions);
            });
        </script>
    </head>
    <body>
        <div style="font-family: sans-serif; padding: 1em">
            <h2>Temporary URL generator</h2>
            <p>
                This widget creates temporary URL for your attachments. It can
                be useful in combination with the markdown widget. To use it:
            </p>
            <ol>
                <li>
                    Select the column where your attachments are. There must be
                    a single attachment by line.
                </li>
                <li>Select the column where you want your generated URLs</li>
                <li>That's all ! You can even collapse this widget.</li>
            </ol>
        </div>
    </body>
</html>
